<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Admin Residuos - Dashboard</title>
<link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet"/>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
<style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f0f2f5;
      color: #2f3640;
      margin: 0;
    }
  
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 220px;
      background-color: #1a1a1a;
      padding-top: 20px;
      display: flex;
      flex-direction: column;
      z-index: 1000;
    }
  
    .sidebar a {
      color: #00bfff;
      padding: 15px;
      text-decoration: none;
      transition: 0.3s;
    }
  
    .sidebar a:hover {
      background-color: #00bfff;
      color: #1a1a1a;
    }
  
    .main {
      margin-left: 220px;
      padding: 20px;
    }
  
    .section {
      display: none;
    }
  
    .active-section {
      display: block;
    }
  
    .datatable-section {
      background: #ffffff;
      padding: 20px;
      margin-bottom: 25px;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
      transition: 0.3s;
    }
  
    h3 {
      color: #0057b7;
      margin-bottom: 18px;
      font-weight: 600;
    }
  
    table.dataTable {
      border-collapse: separate !important;
      border-spacing: 0 8px;
      font-size: 0.92rem;
    }
  
    table.dataTable thead th {
      background-color: #0057b7;
      color: #ffffff;
      border: none;
      padding: 10px 12px;
      font-weight: 600;
      border-radius: 8px 8px 0 0;
      text-align: left;
    }
  
    table.dataTable tbody tr {
      background: #ffffff;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: all 0.2s ease-in-out;
    }
  
    table.dataTable tbody tr:hover {
      background-color: #f4faff;
      transform: scale(1.005);
    }
  
    table.dataTable td {
      padding: 10px 12px;
      border: none;
      border-bottom: 1px solid #e0e0e0;
    }
  
    table.dataTable tfoot td, table.dataTable tfoot th {
      background-color: #e6f3ff;
      font-weight: bold;
      padding: 10px;
      color: #003f88;
    }
  
    #filtroCliente {
      border: 2px solid #00bfff;
      border-radius: 6px;
      padding: 6px 10px;
      font-weight: 500;
      background: #f0faff;
      color: #003f88;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }
    button.btn-sm {
  margin-right: 5px;
  font-size: 13px;
  padding: 4px 8px;
  border-radius: 6px;
}

  </style>
</head>
<body>
<!-- √Årea oculta para generar PDF -->
<div class="sidebar">
<a href="#" onclick="showSection('comercios')">üìã Tabla Comercios</a>
<a href="#" onclick="showSection('manifiestos')">üì¶ Manifiestos</a>
<a href="#" onclick="showSection('residuos')">üìä Totales de Residuos</a>
<a href="comercios_mapa.html">üó∫Ô∏è Mapa de Comercios</a>
<a href="#" onclick="showSection('solicitudes')">üìù Solicitudes de Servicio</a>
</div>
<div class="main">
<div class="section active-section" id="comercios">
<div class="datatable-section">
<h3>Comercios Registrados</h3>
<table class="display" id="comerciosTable" style="width:100%">
<thead>
<tr>
<th>Folio</th>
<th>Nombre</th>
<th>Municipio</th>
<th>Estado</th>
<th>Correo</th>
<th>Tel√©fono</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="section" id="manifiestos">
<div class="datatable-section">
<h3>Manifiestos Emitidos</h3>
<table class="display" id="manifiestosTable" style="width:100%">
<thead>
<tr>
<th>N√∫mero</th>
<th>Generador</th>
<th>Folio Cliente</th>
<th>Status</th>
<th>Validaci√≥n</th>
<th>Fecha Emisi√≥n</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="section" id="residuos">
<div class="datatable-section">
<h3>Resumen Total de Residuos por Clasificaci√≥n</h3>
<!-- Filtro dropdown -->
<div class="form-group mt-2 mb-3">
<label for="filtroCliente"><strong>Filtrar por cliente (Folio Cliente):</strong></label>
<select class="form-control" id="filtroCliente" style="max-width: 300px;">
<option value="">Todos</option>
</select>
</div>
<table class="display" id="tablaResumen" style="width:100%">
<thead>
<tr>
<th>Folio Cliente</th>
<th>Clasificaci√≥n</th>
<th>Total Cantidad</th>
<th>Suma Capacidad (kg)</th>
</tr>
</thead>
<tfoot>
<tr>
<td colspan="2" style="text-align:right"><strong>Totales:</strong></td>
<td id="totalCantidad"></td>
<td id="totalCapacidad"></td>
</tr>
</tfoot>
<tbody></tbody>
</table>
</div>
</div>
<!-- Secci√≥n Solicitudes -->
<div class="section" id="solicitudes">
<div class="datatable-section">
<h3>Solicitudes de Servicio</h3>
<table class="display" id="solicitudesTable" style="width:100%">
<thead>
<tr>
<th># Solicitud</th>
<th>Comercio</th>
<th>FolioCliente</th>
<th>Fecha</th>
<th>Status</th>
<th>Acciones</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<!-- Modal Ver Solicitud -->
<div class="modal fade" id="modalVerSolicitud" role="dialog" tabindex="-1">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header bg-info text-white">
<h5 class="modal-title">Detalles de Solicitud</h5>
<button class="close text-white" data-dismiss="modal" type="button">√ó</button>
</div>
<div class="modal-body" id="detalleSolicitud"></div>
<div class="modal-footer">
<button class="btn btn-outline-success" onclick="exportarPDFdesdeModal()">üìÑ Exportar a PDF</button>
</div>
</div>
</div>
</div>
<!-- Modal Editar Solicitud -->
<div class="modal fade" id="modalEditarSolicitud" role="dialog" tabindex="-1">
<div class="modal-dialog" role="document">
<div class="modal-content">
<div class="modal-header bg-warning text-dark">
<h5 class="modal-title">Editar Cantidades</h5>
<button class="close" data-dismiss="modal" type="button">√ó</button>
</div>
<div class="modal-body" id="formEditar"></div>
<div class="modal-footer">
<button class="btn btn-primary" onclick="guardarCambiosEdicion()" type="button">Guardar</button>
<button class="btn btn-secondary" data-dismiss="modal" type="button">Cancelar</button>
</div>
</div>
</div>
</div>
<!-- √Årea oculta para HTML2PDF -->
<div id="pdfContent" style="display:none;"></div>
</div>
<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
    const firebaseConfig = {
      databaseURL: "https://orientetotal-d7de4-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const solicitudesMap = new Map();


    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active-section'));
      document.getElementById(sectionId).classList.add('active-section');

      if (sectionId === 'comercios') {
        $('#comerciosTable').DataTable().columns.adjust().draw();
      }
      if (sectionId === 'manifiestos') {
        $('#manifiestosTable').DataTable().columns.adjust().draw();
      }
      if (sectionId === 'residuos') {
        $('#tablaResumen').DataTable().columns.adjust().draw();
      }
      if (sectionId === 'solicitudes') {
    $('#solicitudesTable').DataTable().columns.adjust().draw();
      }
    }

    function loadComercios() {
      db.ref("Comercios").once("value", snapshot => {
        const table = $('#comerciosTable').DataTable();
        table.clear();
        snapshot.forEach(child => {
          const c = child.val();
          table.row.add([
            c.folio_cliente || '',
            c.nombre_generador || '',
            c.municipio || '',
            c.estado || '',
            c.email || '',
            c.telefono || ''
          ]);
        });
        table.draw();
      });
    }

    function loadManifiestos() {
      db.ref("Manifiestos").once("value", snapshot => {
        const table = $('#manifiestosTable').DataTable();
        table.clear();
        snapshot.forEach(child => {
          const m = child.val();
          table.row.add([
            m?.num_manif || '',
            m?.nombre_generador || '',
            m?.folio_cliente || '',
            m?.status || '',
            m?.validado_comercio ? 'Validado' : 'Pendiente',
            m?.timestamp_emision || ''
          ]);
        });
        table.draw();
      });
    }

    function loadResumenResiduos() {
      const resumen = [];
      const clientesSet = new Set();

      db.ref("comercio_manifiestoedit").once("value", snapshot => {
        snapshot.forEach(manifiesto => {
          const datos = manifiesto.val();
          const folio = datos.folio_cliente || 'Sin folio';

          if (Array.isArray(datos.residuos)) {
            datos.residuos.forEach(res => {
              const tipo = Array.isArray(res.clasificacion) ? res.clasificacion[0] : "Sin clasificar";
              const cantidad = parseInt(res.cantidad) || 0;
              const capacidad = parseFloat(res.capacidad) || 0;

              resumen.push({ folio_cliente: folio, clasificacion: tipo, cantidad, capacidad });
              clientesSet.add(folio);
            });
          }
        });

        const select = document.getElementById('filtroCliente');
        select.innerHTML = `<option value="">Todos</option>`;
        clientesSet.forEach(folio => {
          const option = document.createElement('option');
          option.value = folio;
          option.textContent = folio;
          select.appendChild(option);
        });

        renderTablaResumen(resumen);

        select.addEventListener('change', () => {
          const filtrado = select.value ? resumen.filter(r => r.folio_cliente === select.value) : resumen;
          renderTablaResumen(filtrado);
        });
      });
    }

    function loadSolicitudes() {
    const tabla = $('#solicitudesTable').DataTable();
    tabla.clear();

    db.ref("SolicitudServicioMnf").once("value", snapshot => {
      snapshot.forEach(child => {
        const s = child.val();
        const acciones = `
          <button class='btn btn-sm btn-info' onclick="verSolicitud('${s.num_solicitud}')">üëÅÔ∏è</button>
          <button class='btn btn-sm btn-warning' onclick="editarSolicitud('${s.num_solicitud}')">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-outline-success" onclick='generarPDF("${child.key}")'>üìÑ</button>
        `;
        solicitudesMap.set(child.key, s);
        tabla.row.add([
          s.num_solicitud || '-',
          //s.num_manifiesto || '-',
          s.nombre_generador || '-',
          s.folio_cliente || '-',
          s.timestamp || '-',
          (s.status_solicitud === 'aceptada')
  ? '<span style="color:green; font-weight:bold;">Aceptada</span>'
  : '<span style="color:red; font-weight:bold;">Pendiente</span>',

          acciones
        ]);
      });
      tabla.draw();
    });
  }

  function verSolicitud(id) {
    db.ref("SolicitudServicioMnf").orderByChild("num_solicitud").equalTo(id).once("value", snap => {
      let html = "";
      snap.forEach(child => {
        const s = child.val();
        html += `<strong>Generador:</strong> ${s.nombre_generador}<br>
      
        <strong>Fecha:</strong> ${s.timestamp}<br>
        <strong>Status:</strong> ${s.status_solicitud}<br>
        <strong>Residuos:</strong>
        <table class='table table-sm table-primary'><thead><tr><th>Tipo</th><th>Cantidad</th><th>Capacidad</th></tr></thead><tbody>`;
        s.residuos.forEach(r => {
          html += `<tr><td>${r.tipo_residuo}</td><td>${r.cantidad}</td><td>${r.capacidad}</td></tr>`;
        });
        html += "</tbody></table>";
      });
      document.getElementById("detalleSolicitud").innerHTML = html;
      $('#modalVerSolicitud').modal('show');
    });
  }

  function editarSolicitud(id) {
    db.ref("SolicitudServicioMnf").orderByChild("num_solicitud").equalTo(id).once("value", snap => {
      snap.forEach(child => {
        const s = child.val();
        const key = child.key;
        let form = "";
        s.residuos.forEach((r, i) => {
          form += `
            <div class='form-group'>
              <label>${r.tipo_residuo}:</label>
              <input type='number' class='form-control' id='residuo_${i}' value='${r.cantidad}'>
            </div>`;
        });
        document.getElementById("formEditar").innerHTML = form;
        $('#modalEditarSolicitud').data('key', key).data('original', s);
        $('#modalEditarSolicitud').modal('show');
      });
    });
  }

  function guardarCambiosEdicion() {
    const key = $('#modalEditarSolicitud').data('key');
    const original = $('#modalEditarSolicitud').data('original');
    original.residuos.forEach((r, i) => {
      r.cantidad = document.getElementById(`residuo_${i}`).value;
    });
    db.ref("SolicitudServicioMnf/" + key).set(original, () => {
      $('#modalEditarSolicitud').modal('hide');
      loadSolicitudes();
    });
  }

  function generarPDF(key) {
  const solicitud = solicitudesMap.get(key);
  if (!solicitud) {
    alert("Solicitud no encontrada.");
    return;
  }

  const html = `
    <div style="font-family:Arial; padding:20px; width:100%;">
      <h2 style="color:#0057b7;">Reporte de Solicitud</h2>
      <p><strong># Solicitud:</strong> ${solicitud.num_solicitud}</p>
      <p><strong># Manifiesto:</strong> ${solicitud.num_manifiesto || 'N/A'}</p>
      <p><strong>Generador:</strong> ${solicitud.nombre_generador}</p>
      <p><strong>Folio Cliente:</strong> ${solicitud.folio_cliente}</p>
      <p><strong>Fecha:</strong> ${solicitud.timestamp}</p>
      <p><strong>Status:</strong> ${solicitud.status_solicitud}</p>
      <h4>Residuos:</h4>
      <table style="width:100%; border-collapse: collapse;" border="1" cellpadding="8">
        <thead>
          <tr style="background-color:#e6f3ff;">
            <th>Tipo</th>
            <th>Cantidad</th>
            <th>Capacidad</th>
          </tr>
        </thead>
        <tbody>
          ${solicitud.residuos?.map(r => `
            <tr>
              <td>${r.tipo_residuo}</td>
              <td>${r.cantidad}</td>
              <td>${r.capacidad}</td>
            </tr>`).join('') || ''}
        </tbody>
      </table>
    </div>
  `;

  const pdfArea = document.getElementById("pdfContent");
  pdfArea.innerHTML = html;

  setTimeout(() => {
    html2pdf().from(pdfArea).set({ margin: 0.5, filename: `Solicitud_${solicitud.num_solicitud}.pdf` }).save();
  }, 300);
}




function verSolicitud(id) {
  db.ref("SolicitudServicioMnf").orderByChild("num_solicitud").equalTo(id).once("value", snap => {
    let html = "";
    snap.forEach(child => {
      const s = child.val();
      html += `<div id="vistaSolicitudPDF">
        <p><strong>Generador:</strong> ${s.nombre_generador}</p>
        <p><strong>Fecha:</strong> ${s.timestamp}</p>
        <p><strong>Status:</strong> ${s.status_solicitud}</p>
        <p><strong>Folio Cliente:</strong> ${s.folio_cliente}</p>
        <table class='table table-bordered table-sm'>
          <thead><tr><th>Tipo</th><th>Cantidad</th><th>Capacidad</th></tr></thead>
          <tbody>`;
      s.residuos.forEach(r => {
        html += `<tr><td>${r.tipo_residuo}</td><td>${r.cantidad}</td><td>${r.capacidad}</td></tr>`;
      });
      html += `</tbody></table></div>`;
    });
    document.getElementById("detalleSolicitud").innerHTML = html;
    $('#modalVerSolicitud').modal('show');
  });
}

function exportarPDFdesdeModal() {
  const vista = document.getElementById("vistaSolicitudPDF");
  if (!vista) {
    alert("Vista previa no encontrada.");
    return;
  }

  const htmlOriginal = vista.innerHTML;
  const htmlMejorado = `
    <style>
      * { font-family: Arial, sans-serif; }
      .header-logo {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }
      .header-logo img {
        height: 60px;
        margin-right: 15px;
      }
      h2 {
        color: #0057b7;
        margin-bottom: 10px;
      }
      .info p {
        margin: 4px 0;
        font-size: 14px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th, td {
        border: 1px solid #ccc;
        padding: 8px;
        font-size: 13px;
        text-align: center;
      }
      th {
        background-color: #0057b7;
        color: white;
      }
      .firmas {
        margin-top: 50px;
        display: flex;
        justify-content: space-between;
      }
      .firmas div {
        width: 45%;
        text-align: center;
        padding-top: 10px;
        border-top: 1px solid #333;
        font-size: 14px;
      }
    </style>

    <div style="padding: 30px;">
      <div class="header-logo">
        <img src="logo2.png" alt="Logo" />
        <h2>Reporte de Solicitud de Servicio</h2>
      </div>
      <div class="info">${htmlOriginal}</div>
      <div class="firmas">
        <div>Firma Encargado de Planta</div>
        <div>Firma del Recolector</div>
      </div>
    </div>
  `;

  const divTemporal = document.createElement('div');
  divTemporal.innerHTML = htmlMejorado;

  // Aplicar separador de miles manualmente
  divTemporal.querySelectorAll("td").forEach(td => {
    const num = parseFloat(td.textContent);
    if (!isNaN(num) && num > 999) {
      td.textContent = num.toLocaleString('en-US');
    }
  });

  document.body.appendChild(divTemporal);

  html2pdf().set({
    margin: 0.5,
    filename: 'Solicitud_Servicio.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
  }).from(divTemporal).save().then(() => {
    document.body.removeChild(divTemporal);
  });
}


    function renderTablaResumen(data) {
      const tabla = $('#tablaResumen').DataTable();
      tabla.clear();

      let totalCantidad = 0;
      let totalCapacidad = 0;

      data.forEach(item => {
        tabla.row.add([
          item.folio_cliente,
          item.clasificacion,
          item.cantidad,
          item.capacidad.toFixed(2)
        ]);
        totalCantidad += item.cantidad;
totalCapacidad += item.capacidad * item.cantidad;

      });

      tabla.draw();

      document.getElementById('totalCantidad').innerHTML = `<strong>${totalCantidad}</strong>`;
document.getElementById('totalCapacidad').innerHTML = `<strong>${totalCapacidad.toFixed(2)}</strong>`;

    }

    $(document).ready(function() {
      $('#comerciosTable').DataTable();
      $('#manifiestosTable').DataTable();
      $('#tablaResumen').DataTable({
        footerCallback: function () {}
      });
      $('#solicitudesTable').DataTable();
      


      loadComercios();
      loadManifiestos();
      loadResumenResiduos();
      loadSolicitudes();

    });
  </script>
<!-- jQuery primero -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<!-- DataTables -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>



<script>
function exportarPDFdesdeModal() {
  const vista = document.getElementById("vistaSolicitudPDF");
  if (!vista) {
    alert("Vista previa no encontrada.");
    return;
  }

  const contenido = `
    <style>
      * { font-family: Arial, sans-serif; }
      .header-logo {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }
      .header-logo img {
        height: 60px;
        margin-right: 15px;
      }
      h2 {
        color: #0057b7;
        margin-bottom: 10px;
      }
      .info p {
        margin: 4px 0;
        font-size: 14px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th, td {
        border: 1px solid #ccc;
        padding: 8px;
        font-size: 13px;
        text-align: center;
      }
      th {
        background-color: #0057b7;
        color: white;
      }
      .firmas {
        margin-top: 50px;
        display: flex;
        justify-content: space-between;
      }
      .firmas div {
        width: 45%;
        text-align: center;
        padding-top: 10px;
        border-top: 1px solid #333;
        font-size: 14px;
      }
    </style>

    <div style="padding: 30px;">
      <div class="header-logo">
        <img src="logo2.png" alt="Logo" />
        <h2>Reporte de Solicitud de Servicio</h2>
      </div>
      <div class="info">
        ${vista.innerHTML}
      </div>
      <div class="firmas">
        <div>Firma Encargado de Planta</div>
        <div>Firma del Recolector</div>
      </div>
    </div>
  `;

  const divTemporal = document.createElement('div');
  divTemporal.innerHTML = contenido;

  divTemporal.querySelectorAll("td").forEach(td => {
    const num = parseFloat(td.textContent.replace(',', ''));
    if (!isNaN(num) && num > 999) {
      td.textContent = num.toLocaleString('es-MX');
    }
  });

  document.body.appendChild(divTemporal);

  html2pdf().set({
    margin: 0.5,
    filename: 'Solicitud_Servicio.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
  }).from(divTemporal).save().then(() => {
    document.body.removeChild(divTemporal);
  });
}
</script>

</body>
</html>
